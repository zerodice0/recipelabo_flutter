name: Update Translations from Google Sheets

on:
  # Run daily at 9 AM KST (midnight UTC)
  schedule:
    - cron: '0 0 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      sheet_id:
        description: 'Google Sheets ID (optional, uses default if not provided)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (preview changes without committing)'
        required: false
        type: boolean
        default: false

env:
  FLUTTER_VERSION: '3.24.3'

jobs:
  update-translations:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      
      - name: Verify script exists
        run: |
          if [ -f "scripts/update_translations.dart" ]; then
            echo "✅ Translation script found"
          else
            echo "❌ Translation script not found"
            exit 1
          fi
      
      - name: Check if translations need update
        id: check_update
        env:
          GOOGLE_SHEETS_API_KEY: ${{ secrets.GOOGLE_SHEETS_API_KEY }}
        run: |
          echo "🔍 Checking for translation updates..."
          
          # Determine sheet ID (use input or default from script)
          SHEET_ID="${{ github.event.inputs.sheet_id }}"
          if [ -z "$SHEET_ID" ]; then
            echo "Using default sheet ID from script"
            SHEET_ID=""  # Will use default from script
          fi
          
          echo "sheet_id=$SHEET_ID" >> $GITHUB_OUTPUT
          
          # Run dry-run to check for changes
          if [ -z "$SHEET_ID" ]; then
            # Use default sheet ID from script
            if dart scripts/update_translations.dart --dry-run; then
              echo "needs_update=true" >> $GITHUB_OUTPUT
              echo "✅ Translation update check completed"
            else
              echo "needs_update=false" >> $GITHUB_OUTPUT
              echo "❌ Translation update check failed"
              exit 1
            fi
          else
            # Use provided sheet ID
            if dart scripts/update_translations.dart --dry-run "$SHEET_ID"; then
              echo "needs_update=true" >> $GITHUB_OUTPUT
              echo "✅ Translation update check completed"
            else
              echo "needs_update=false" >> $GITHUB_OUTPUT
              echo "❌ Translation update check failed"
              exit 1
            fi
          fi
      
      - name: Update translations
        if: steps.check_update.outputs.needs_update == 'true' && github.event.inputs.dry_run != 'true'
        env:
          GOOGLE_SHEETS_API_KEY: ${{ secrets.GOOGLE_SHEETS_API_KEY }}
        run: |
          echo "📥 Downloading and updating translations..."
          SHEET_ID="${{ steps.check_update.outputs.sheet_id }}"
          if [ -z "$SHEET_ID" ]; then
            dart scripts/update_translations.dart
          else
            dart scripts/update_translations.dart "$SHEET_ID"
          fi
      
      - name: Generate Flutter localizations
        if: steps.check_update.outputs.needs_update == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          echo "🏗️ Generating Flutter localization files..."
          flutter gen-l10n
      
      - name: Check for changes
        if: steps.check_update.outputs.needs_update == 'true' && github.event.inputs.dry_run != 'true'
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ℹ️ No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "✅ Changes detected"
            
            # Show what changed
            echo "📋 Changed files:"
            git diff --name-only
            
            echo "📄 Diff summary:"
            git diff --stat
          fi
      
      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            feat: Update translations from Google Sheets
            
            - Updated ARB files with latest translations
            - Regenerated Flutter localization files
            
            🤖 Auto-generated by GitHub Actions
          title: '🌍 Update translations from Google Sheets'
          body: |
            ## 🌍 Translation Update
            
            This PR contains updated translations downloaded from Google Sheets.
            
            ### Changes
            - ✅ Updated ARB files (`lib/l10n/app_*.arb`)
            - ✅ Regenerated Flutter localization files
            
            ### Review Checklist
            - [ ] Check that all required translations are present
            - [ ] Verify that parameterized strings work correctly
            - [ ] Test app with different locales
            - [ ] Ensure no breaking changes in translation keys
            
            ### Auto-generated
            🤖 This PR was automatically generated by the translation update workflow.
            📊 Source: Google Sheets
            ⏰ Generated at: ${{ github.run_id }}
            
            ---
            
            **Note**: This PR can be safely merged if all checks pass and translations look correct.
          branch: translations/update-${{ github.run_number }}
          delete-branch: true
          labels: |
            enhancement
            translations
            automated
      
      - name: Dry run summary
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "🔍 DRY RUN COMPLETED"
          echo "No changes were committed. This was a preview run."
          echo "To apply changes, run the workflow without dry_run option."
      
      - name: Workflow summary
        run: |
          echo "## 🌍 Translation Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Sheet ID | ${{ steps.check_update.outputs.sheet_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Needs Update | ${{ steps.check_update.outputs.needs_update }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Has Changes | ${{ steps.check_changes.outputs.has_changes || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ github.event.inputs.dry_run || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 📄 Changed Files" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git diff --name-only >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi