name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.0'
        channel: 'stable'
        
    - name: Create .env file
      env:
        ANDROID_BANNER_AD_ID: ${{ secrets.SAUCERER_ANDROID_BANNER_AD_ID }}
        IOS_BANNER_AD_ID: ${{ secrets.SAUCERER_IOS_BANNER_AD_ID }}
        GOOGLE_SHEETS_API_KEY: ${{ secrets.SAUCERER_GOOGLE_SHEETS_API_KEY }}
      run: |
        echo "# Saucerer Flutter í”„ë¡œì íŠ¸ í™˜ê²½ë³€ìˆ˜" > .env
        echo "# GitHub Actionsì—ì„œ ìë™ ìƒì„±ë¨" >> .env
        echo "" >> .env
        echo "# AdMob ê´‘ê³  ID ì„¤ì •" >> .env
        echo "SAUCERER_ANDROID_BANNER_AD_ID=${ANDROID_BANNER_AD_ID}" >> .env
        echo "SAUCERER_IOS_BANNER_AD_ID=${IOS_BANNER_AD_ID}" >> .env
        echo "" >> .env
        echo "# í…ŒìŠ¤íŠ¸ ê´‘ê³  ID (Googleì—ì„œ ì œê³µí•˜ëŠ” ê³µìš© í…ŒìŠ¤íŠ¸ ID)" >> .env
        echo "SAUCERER_TEST_ANDROID_BANNER_AD_ID=ca-app-pub-3940256099942544/6300978111" >> .env
        echo "SAUCERER_TEST_IOS_BANNER_AD_ID=ca-app-pub-3940256099942544/2934735716" >> .env
        echo "" >> .env
        echo "# Google Sheets API ì„¤ì • (ë²ˆì—­ ê´€ë¦¬ìš©)" >> .env
        echo "SAUCERER_GOOGLE_SHEETS_API_KEY=${GOOGLE_SHEETS_API_KEY}" >> .env
        echo "" >> .env
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Verify the .env file was created
      run: |
        echo "âœ… .env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤:"
        ls -la .env
        echo ""
        echo "ğŸ“‹ .env íŒŒì¼ ë‚´ìš© (ë¯¼ê°í•œ ì •ë³´ ì œì™¸):"
        grep -v "GOOGLE_SERVICE_ACCOUNT_JSON\|ANDROID_BANNER_AD_ID\|IOS_BANNER_AD_ID\|GOOGLE_SHEETS_API_KEY" .env || echo "ëª¨ë“  ë‚´ìš©ì´ ë¯¼ê°í•œ ì •ë³´ì…ë‹ˆë‹¤."
        
    - name: Analyze project source
      run: flutter analyze
      
    - name: Run tests
      run: flutter test

  update-translations:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Dart
      uses: dart-lang/setup-dart@v1
      with:
        sdk: stable
        
    - name: Create .env file
      run: |
        echo "# Saucerer Flutter í”„ë¡œì íŠ¸ í™˜ê²½ë³€ìˆ˜" > .env
        echo "SAUCERER_GOOGLE_SERVICE_ACCOUNT_JSON=${{ secrets.SAUCERER_GOOGLE_SERVICE_ACCOUNT_JSON }}" >> .env
        
    - name: Get dependencies
      run: dart pub get
      
    - name: Update translations from Google Sheets
      run: |
        echo "ğŸŒ Google Sheetsì—ì„œ ë²ˆì—­ ì—…ë°ì´íŠ¸ ì¤‘..."
        dart scripts/update_translations.dart || echo "âš ï¸ ë²ˆì—­ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (ì„ íƒì‚¬í•­)"
        
    - name: Commit updated translations
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add lib/l10n/
        git diff --staged --quiet || git commit -m "chore: ë²ˆì—­ íŒŒì¼ ìë™ ì—…ë°ì´íŠ¸

        ğŸ¤– GitHub Actionsì—ì„œ Google Sheets ë²ˆì—­ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ARB íŒŒì¼ì„ ìë™ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.
        
        Co-authored-by: GitHub Actions <action@github.com>"
        git push || echo "ğŸ“ ì—…ë°ì´íŠ¸í•  ë²ˆì—­ì´ ì—†ìŠµë‹ˆë‹¤."